#!/usr/bin/env node

// BUG: prompt input longer than line gets unsightly

process.env.START_AS_ROOTED = 1;

var commander = require('commander');
var happner; // = require('../');      // hard choice:
                                      //  ------------
var merge = require('merge');        // - decided to use the happner version
                                    //    from the --conf location
                                   //   - the one which that config was
                                  //      written for.
var config = {
  name: 'localnode',
  components: {
    'terminal': {}, // <--- first, so that other's start methods can write in command actions
    'www': {},
    'demo': {
      startMethod: 'start',
      stopMethod: 'stop'
    }
  }
};

var path = require('path');

var loaded, configPath;

// Using --conf [../some/other/file] to load a mesh node
// updates the module search paths to operate as if at
// that location.

var replaceSearchPath = function(startAt) {

  console.warn('WARN: Replacing module search path!');
  console.warn('WARN: New path starts at ' + startAt);
  console.warn('INFO: Will load happner from that location.');

  // Flush existing path to prevent false resolves
  // from the meshnode being started at --conf location

  module.paths.length = 0;

  var addPath = function(dir) {
    module.paths.push(path.normalize(dir + path.sep + 'node_modules'));
  }

  var recurse = function(dir) {
    addPath(dir);
    var next = path.dirname(dir);
    if (next.length < 2) return addPath(next);
    recurse(next);
  }

  recurse(startAt);
}

commander

.version(JSON.parse(require('fs').readFileSync(__dirname + '/../package.json')).version)
.option('')
.option('--conf [file]',         'Load mesh config from file/module (js)') // ie. module.exports = {/* the config */}
.option('',                      ' use: module.exports.config = {};')
.option('',                      '  or: module.exports = { /* config */ };')
.option('')
.option('--trace',               'Set LOG_LEVEL=trace')
.option('--debug',               'Set LOG_LEVEL=debug')
.option('')
.option('--alt-prompt [\'txt\']','Alternate prompt text')
.option('')
.parse(process.argv);

if (commander.debug) process.env.LOG_LEVEL = 'debug';
if (commander.trace) process.env.LOG_LEVEL = 'trace';

if (commander.conf) {
  try {
    loaded = require(commander.conf);
    happner = require('../');
  } catch (e) {
    var ster = e.toString();
    try {
      configPath = process.cwd() + path.sep + commander.conf;
      loaded = require(configPath);
      replaceSearchPath(path.dirname(require.resolve(configPath)));

      try {
        happner = require('happner');
      } catch (e) {
        happner = require('../');
      }

    } catch (e) {
      console.log(ster);
      process.exit(1);
    }
  }
  config = merge.recursive(config, loaded.config || loaded);
} else {
  happner = require('../');
}

happner.start(config, function(e, mesh) {
  if (e) {
    console.log(e.toString());
    process.exit(1);
  }

  mesh.exchange.terminal.start(commander.altPrompt 
    || process.env.HAPPNER_PROMPT //  export HAPPNER_PROMPT='. '  # in .bash_profile
    || 'â–º ', function(eee, prompt) {
    // eee is array! of [e,e,e] if errors ocurred
   // prompt started anyway.
  });
});
