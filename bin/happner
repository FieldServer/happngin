#!/usr/bin/env node

// BUG: prompt input longer than line gets unsightly

process.env.START_AS_ROOTED = 1;
process.env.EXIT_ON_SIGINT = 1;

var commander = require('commander');
var happner = require('../');
var merge = require('merge');

var config = {
  name: 'localnode',
  components: {
    'terminal': {}
  }
};

var path = require('path');

var loaded;

commander

.version(JSON.parse(require('fs').readFileSync(__dirname + '/../package.json')).version)
.option('')
.option('--conf [file]',    'Load mesh config from file/module (js)') // ie. module.exports = {/* the config */}
.option('',                 ' use: module.exports.config = {};')
.option('',                 '  or: module.exports = { /* config */ };')
.option('')
.option('--trace',          'Set LOG_LEVEL=trace')
.option('--debug',          'Set LOG_LEVEL=debug')
.option('')
.option('--alt-prompt [\'txt\']','Alternate prompt text')
.option('')
.parse(process.argv);

if (commander.debug) process.env.LOG_LEVEL = 'debug';
if (commander.trace) process.env.LOG_LEVEL = 'trace';

if (commander.conf) {
  try {
    loaded = require(commander.conf);
  } catch (e) {
    var ster = e.toString();
    try {
      loaded = require(process.cwd() + path.sep + commander.conf);
    } catch (e) {
      console.log(ster);
      process.exit(1);
    }
  }
  config = merge.recursive(config, loaded.config || loaded);
}

happner.start(config, function(e, mesh) {
  if (e) {
    console.log(e.toString());
    process.exit(1);
  }

  mesh.exchange.terminal.start(commander.altPrompt 
    || process.env.HAPPNER_PROMPT 
    || 'â–º ', function(e, prompt) {
    // e is array! of [e,e,e]
   // prompt started anyway.
  });
});
